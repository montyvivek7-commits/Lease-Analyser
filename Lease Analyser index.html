<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Leasehold Property Buyer's Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Light gray-blue background */
        }
        .step-card {
            transition: all 0.3s ease;
            cursor: default;
        }
        .step-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .ai-response {
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        
        <!-- Header Section -->
        <header class="text-center py-8 bg-white rounded-xl shadow-md mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-700">
                <span class="text-indigo-500">AI</span> Leasehold Buyer's Guide
            </h1>
            <p class="mt-2 text-gray-600">Navigate the complexities of buying a leasehold property with confidence.</p>
        </header>

        <!-- What is Leasehold? -->
        <section class="mb-10 bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Understanding Leasehold</h2>
            <p class="text-gray-700 leading-relaxed mb-4">
                When you buy a leasehold property (typically a flat), you own the right to live there for a fixed period (the term of the lease). You do **not** own the land or the structure of the building; that belongs to the Freeholder (Landlord). This is why you will have Ground Rent and Service Charges.
            </p>
            <!-- Informative image related to the topic of Leasehold vs Freehold -->
            
        </section>

        <!-- Core Steps & Checks Section -->
        <section class="mb-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">The Buyer's Mandatory Checklist</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <!-- Check 1: Lease Length -->
                <div class="step-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-500">
                    <h3 class="text-xl font-semibold text-gray-800 flex items-center mb-2">
                        <span class="mr-3 text-2xl text-indigo-500">1.</span> Lease Term
                    </h3>
                    <p class="text-gray-600">
                        <span class="font-semibold text-red-500">Ask:</span> How many years remain on the lease?
                    </p>
                    <p class="text-sm mt-2 text-gray-500">
                        <span class="font-medium">Check:</span> **Avoid leases with less than 85 years remaining.** Mortgages become difficult to obtain below 80 years, and the cost of extension increases significantly.
                    </p>
                </div>
                
                <!-- Check 2: Ground Rent & Escalation -->
                <div class="step-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-500">
                    <h3 class="text-xl font-semibold text-gray-800 flex items-center mb-2">
                        <span class="mr-3 text-2xl text-indigo-500">2.</span> Ground Rent
                    </h3>
                    <p class="text-gray-600">
                        <span class="font-semibold text-red-500">Ask:</span> What is the current ground rent, and how does it increase?
                    </p>
                    <p class="text-sm mt-2 text-gray-500">
                        <span class="font-medium">Check:</span> **Flag any "doubling clauses"** (e.g., doubling every 10 or 20 years). These are often rejected by mortgage lenders and make the property unsaleable. RPI-linked increases are generally safer.
                    </p>
                </div>
                
                <!-- Check 3: Service Charges -->
                <div class="step-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-500">
                    <h3 class="text-xl font-semibold text-gray-800 flex items-center mb-2">
                        <span class="mr-3 text-2xl text-indigo-500">3.</span> Service Charges
                    </h3>
                    <p class="text-gray-600">
                        <span class="font-semibold text-red-500">Ask:</span> What is the last 3 years' service charge history? Is there a reserve/sinking fund?
                    </p>
                    <p class="text-sm mt-2 text-gray-500">
                        <span class="font-medium">Check:</span> Ensure the charges are reasonable for the services provided. A healthy **sinking fund** is crucial to cover unexpected major repairs (e.g., roof replacement).
                    </p>
                </div>

                <!-- Check 4: Major Works & Disputes -->
                <div class="step-card bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-500">
                    <h3 class="text-xl font-semibold text-gray-800 flex items-center mb-2">
                        <span class="mr-3 text-2xl text-indigo-500">4.</span> Covenants & Works
                    </h3>
                    <p class="text-gray-600">
                        <span class="font-semibold text-red-500">Ask:</span> Are there any planned major works or current disputes with the Freeholder?
                    </p>
                    <p class="text-sm mt-2 text-gray-500">
                        <span class="font-medium">Check:</span> Read covenants carefully (pets, subletting, alterations). Ensure the seller is not shielding you from a **major upcoming bill** for building repairs.
                    </p>
                </div>

            </div>
        </section>


        <!-- AI Analyst Interactive Tool Section -->
        <section class="bg-indigo-50 p-6 md:p-8 rounded-xl shadow-inner border-2 border-indigo-200">
            <h2 class="text-2xl font-bold text-indigo-800 mb-4 flex items-center">
                AI Lease Analyst
                <svg class="ml-2 w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
            </h2>
            <p class="text-indigo-700 mb-4">
                Ask a specific question about a lease term, and optionally upload a photo of the document section for better analysis.
            </p>
            
            <!-- File Upload Input -->
            <div class="mb-4">
                <label for="documentUpload" class="block text-sm font-medium text-indigo-700 mb-1">Upload Document Snippet (Optional - PNG/JPEG only):</label>
                <input type="file" id="documentUpload" accept="image/png, image/jpeg" class="w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-indigo-50 file:text-indigo-700
                    hover:file:bg-indigo-100"
                />
            </div>

            <textarea id="userQuery" class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-none text-gray-800" rows="3" placeholder="Example: 'I've attached a photo of the ground rent clause. Can you analyze the increase schedule?'"></textarea>
            
            <button onclick="analyzeLease()" id="analyzeButton" class="mt-3 w-full md:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                Analyze Lease Term
            </button>
            
            <div id="loadingIndicator" class="mt-4 text-indigo-600 font-medium hidden">
                Analyzing... Please wait a moment.
            </div>

            <div id="aiResponseContainer" class="mt-6 p-4 bg-white rounded-lg shadow-lg hidden">
                <p class="font-bold text-lg text-indigo-800 mb-2">AI Assessment:</p>
                <div id="aiResponseText" class="ai-response text-gray-700"></div>
            </div>
        </section>

    </div>

    <script>
        // Global variables for Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const apiKey = ""; // Canvas provides this securely at runtime
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // System Instruction to force the AI model into a specific persona and output format (JSON)
        const SYSTEM_PROMPT = `You are a specialist, expert Leasehold Property Analyst. Your task is to analyze a property buyer's specific question about a lease term and any accompanying visual document snippet.
If a document is attached, carefully analyze the text, clauses, and figures visible in the image before answering. Provide a concise risk assessment and clear, actionable advice.

You MUST respond strictly in JSON format. Do not include any pre-amble, commentary, or text outside the JSON object.

The JSON structure must be:
{
  "risk_level": "CRITICAL" | "HIGH" | "MEDIUM" | "LOW" | "GENERAL",
  "risk_summary": "[A concise, specific summary of the risk, e.g., 'CRITICAL RISK (Mortgage/Saleability)']",
  "advice": "[A multi-paragraph, detailed, and actionable advice section for the buyer. Start the final paragraph with ACTION: ]"
}

Ensure the 'advice' section uses markdown formatting like **bold text** for emphasis. Focus on UK leasehold law and conveyancing practice.`;

        // Map risk levels to Tailwind CSS colors
        const RISK_COLORS = {
            'CRITICAL': 'text-red-600',
            'HIGH': 'text-orange-500',
            'MEDIUM': 'text-yellow-600',
            'LOW': 'text-blue-600',
            'GENERAL': 'text-gray-700'
        };

        /**
         * Converts a File object (image) to a Base64 string for the API payload.
         * @param {File} file - The file to convert.
         * @returns {Promise<string>} - Base64 encoded string of the file data.
         */
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        // --- API Connected Function with Retry Logic ---
        const callGeminiAnalyst = async (query, base64Image, mimeType, maxRetries = 5) => {
            let parts = [{ text: query }];

            // 1. Add image part if provided
            if (base64Image && mimeType) {
                parts.push({
                    inlineData: {
                        mimeType: mimeType,
                        data: base64Image
                    }
                });
            }

            const payload = {
                contents: [{ parts: parts }],
                systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "risk_level": { "type": "STRING", "enum": ["CRITICAL", "HIGH", "MEDIUM", "LOW", "GENERAL"] },
                            "risk_summary": { "type": "STRING" },
                            "advice": { "type": "STRING" }
                        },
                        required: ["risk_level", "risk_summary", "advice"]
                    }
                }
            };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue; // Retry
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const textContent = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (textContent) {
                        // The model is instructed to return a stringified JSON object
                        return JSON.parse(textContent);
                    }
                    throw new Error("Invalid response structure from AI.");

                } catch (error) {
                    console.error("Gemini API Error:", error);
                    if (attempt === maxRetries - 1) {
                        throw new Error("Failed to get analysis after multiple retries.");
                    }
                }
            }
        };

        // --- Frontend Interaction Function ---
        const analyzeLease = async () => {
            const query = document.getElementById('userQuery').value.trim();
            const fileInput = document.getElementById('documentUpload');
            const file = fileInput.files[0];

            const loadingIndicator = document.getElementById('loadingIndicator');
            const aiResponseContainer = document.getElementById('aiResponseContainer');
            const aiResponseText = document.getElementById('aiResponseText');
            const analyzeButton = document.getElementById('analyzeButton');
            
            // Clear previous response/error
            aiResponseText.innerHTML = '';
            aiResponseContainer.classList.add('hidden');


            if (query.length < 10) {
                aiResponseText.innerHTML = `<p class="text-red-500">Please enter a detailed question about the lease (minimum 10 characters).</p>`;
                aiResponseContainer.classList.remove('hidden');
                return;
            }

            analyzeButton.disabled = true;
            loadingIndicator.classList.remove('hidden');

            let base64Image = null;
            let mimeType = null;

            try {
                // 1. Process file upload if present
                if (file) {
                    if (!file.type.startsWith('image/')) {
                         throw new Error("Unsupported file type. Please upload a PNG or JPEG image.");
                    }
                    base64Image = await fileToBase64(file);
                    mimeType = file.type;
                }
                
                // 2. Call the AI analyst with or without the image
                const analysis = await callGeminiAnalyst(query, base64Image, mimeType);
                const riskColor = RISK_COLORS[analysis.risk_level.toUpperCase()] || RISK_COLORS.GENERAL;
                
                // 3. Format the response for display
                aiResponseText.innerHTML = `
                    <div class="font-bold text-xl mb-2 ${riskColor}">Risk Level: ${analysis.risk_level} - ${analysis.risk_summary}</div>
                    <p class="text-gray-700">${analysis.advice}</p>
                `;

            } catch (error) {
                aiResponseText.innerHTML = `<p class="text-red-500 font-semibold">Error during analysis:</p>
                                            <p class="text-gray-700">${error.message}. If the error relates to API failure, please try again.</p>`;
            } finally {
                loadingIndicator.classList.add('hidden');
                aiResponseContainer.classList.remove('hidden');
                analyzeButton.disabled = false;
                // Clear the file input after analysis
                fileInput.value = ''; 
            }
        };
    </script>
</body>
</html>